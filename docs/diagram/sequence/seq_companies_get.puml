@startuml
title Companies Flow: GET /api/companies
actor Client
participant "«Node.js»\nserver" as Server
participant "«router»\ncompanies" as Router
participant "«controller»\ncompanies" as Ctrl
participant "«model»\nCompany" as CompanyModel
database "«MongoDB»\nDatabase" as DB

== Api/companies ==
Client -> Server : GET /api/companies
activate Server
Server -> Router : router.get('/companies', getCompanies)
deactivate Server
activate Router

Router -> Ctrl : getCompanies(req, res)
deactivate Router
activate Ctrl

Ctrl -> Ctrl : copy req.query to reqQuery
Ctrl -> Ctrl : remove select/sort/page/limit
Ctrl -> Ctrl : build queryStr with gt/gte/lt/lte/in

Ctrl -> CompanyModel : Company.find(JSON.parse(queryStr)).populate('bookings')
activate CompanyModel
CompanyModel -> DB : query companies
activate DB
DB --> CompanyModel : companies (query object)
deactivate DB
CompanyModel --> Ctrl : companies query
deactivate CompanyModel

Ctrl -> Ctrl : apply select/sort/page/limit
Ctrl -> Ctrl : calc startIndex/endIndex/page/limit
Ctrl -> Ctrl : build pagination object

Ctrl -> Ctrl : execute query (await companies)

Ctrl --> Client : 200 OK { success:true, count, pagination, data:companies }

deactivate Ctrl
== Api/companies ==
@enduml
