@startuml
title Bookings Flow: POST /api/companies/:companyId/bookings
actor Client
participant "«Node.js»\nserver" as Server
participant "«router»\nbookings" as Router
participant "«middleware»\nauth" as AuthMW
participant "«controller»\nbookings" as Ctrl
participant "«model»\nBooking" as BookingModel
database "«MongoDB»\nDatabase" as DB

== Api/companies/:companyid/Bookings ==
Client -> Server : POST /api/companies/:companyId/bookings
activate Server
Server -> Router : router.post('/companies/:companyId/bookings', protect, createBooking)
activate Router
Router -> AuthMW : protect(req, res, next)
activate AuthMW
AuthMW -> DB : verify JWT / load user
activate DB
DB --> AuthMW : user / ok
deactivate DB
AuthMW --> Router : next()
deactivate AuthMW
Router -> Ctrl : createBooking(req, res)
activate Ctrl
alt role == admin
  Ctrl --> Client : 403 Forbidden (admin cannot book)
else role != admin
  Ctrl -> DB : Company.findById(companyId)
  activate DB
  DB --> Ctrl : company or null
  deactivate DB
  alt company not found
    Ctrl --> Client : 404 Not Found
  else company exists
    Ctrl -> Ctrl : validate bookingDate within May 10–13, 2022
    alt date invalid
      Ctrl --> Client : 400 Bad Request (date out of range)
    else date valid
      Ctrl -> DB : Booking.find({ user:req.user.id })
      activate DB
      DB --> Ctrl : existing[]
      deactivate DB
      alt existing.length >= 3
        Ctrl --> Client : 400 Bad Request (limit reached)
      else < 3
        Ctrl -> DB : Booking.create(req.body)
        activate DB
        DB --> Ctrl : booking
        deactivate DB
        Ctrl -> DB : Booking.findById(booking._id).populate(user, company)
        activate DB
        DB --> Ctrl : populatedBooking
        deactivate DB
        Ctrl --> Client : 201 Created { data: populatedBooking }
      end
    end
  end
end
deactivate Ctrl
deactivate Router
deactivate Server
== Api/companies/:companyid/Bookings ==
@enduml