@startuml
title Bookings Flow: POST /api/companies/:companyId/bookings
actor Client
participant "«Node.js»\nserver" as Server
participant "«router»\nbookings" as Router
participant "«middleware»\nauth" as AuthMW
participant "«controller»\nbookings" as Ctrl
participant "«model»\nCompany" as CompanyModel
participant "«model»\nBooking" as BookingModel
database "«MongoDB»\nDatabase" as DB

== Api/companies/:companyId/bookings ==
Client -> Server : POST /api/companies/:companyId/bookings
activate Server
Server -> Router : router.post('/companies/:companyId/bookings', protect, createBooking)
deactivate Server
activate Router

Router -> AuthMW : protect(req, res, next)
activate AuthMW
AuthMW -> DB : verify JWT / load user
activate DB
DB --> AuthMW : user or null
deactivate DB

alt valid token
  AuthMW --> Router : next()
else invalid or missing token
  AuthMW --> Client : 401 Unauthorized
  deactivate AuthMW
end
deactivate AuthMW

Router -> Ctrl : createBooking(req, res)
deactivate Router
activate Ctrl

' ---- ห้าม admin จอง ----
alt req.user.role === "admin"
  Ctrl --> Client : 403 Forbidden { success:false, message:"Admin is not allowed to book interview sessions" }
  deactivate Server
else continue
end

Ctrl -> Ctrl : req.body.company = req.params.companyId

Ctrl -> CompanyModel : Company.findById(req.params.companyId)
activate CompanyModel
CompanyModel -> DB : query company by id
activate DB
DB --> CompanyModel : company or null
deactivate DB
CompanyModel --> Ctrl : company or null
deactivate CompanyModel

alt company not found
  Ctrl --> Client : 404 Not Found { success:false, message:`No company with the id of ${req.params.companyId}` }
  deactivate Router
  deactivate Server
else continue
end

' ---- เช็คช่วงวันที่ ----
Ctrl -> Ctrl : set interviewDate, startDate, endDate

alt (interviewDate < startDate) OR (interviewDate > endDate)
  Ctrl --> Client : 400 Bad Request { success:false, message:"Interview date must be between May 10 and May 13, 2022" }
  deactivate Router
  deactivate Server
else continue
end

Ctrl -> Ctrl : req.body.user = req.user.id

Ctrl -> BookingModel : Booking.find({ user:req.user.id })
activate BookingModel
BookingModel -> DB : query existing bookings by user
activate DB
DB --> BookingModel : existingBookings[]
deactivate DB
BookingModel --> Ctrl : existingBookings[]
deactivate BookingModel

alt existingBookings.length >= 3
  Ctrl --> Client : 400 Bad Request { success:false, message:`The user with ID ${req.user.id} has already made 3 bookings` }
  deactivate Router
  deactivate Server
else continue
end

Ctrl -> Ctrl : req.body.status = "pending"

Ctrl -> BookingModel : Booking.create(req.body)
activate BookingModel
BookingModel -> DB : insert booking
activate DB
DB --> BookingModel : booking
deactivate DB
BookingModel --> Ctrl : booking
deactivate BookingModel

Ctrl -> BookingModel : Booking.findById(booking._id).populate(user,company)
activate BookingModel
BookingModel -> DB : query booking with populate
activate DB
DB --> BookingModel : populatedBooking
deactivate DB
BookingModel --> Ctrl : populatedBooking
deactivate BookingModel

Ctrl --> Client : 201 Created { success:true, data:populatedBooking }

deactivate Ctrl
deactivate Router
deactivate Server
== Api/companies/:companyId/bookings ==
@enduml
