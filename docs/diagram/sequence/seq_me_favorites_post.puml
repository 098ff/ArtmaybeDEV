@startuml
title Favorites Flow: POST /api/me/favorites
actor Client
participant "«Node.js»\nserver" as Server
participant "«router»\nfavorites" as Router
participant "«middleware»\nauth" as AuthMW
participant "«controller»\nfavorites" as Ctrl
participant "«model»\nFavorite" as FavoriteModel
database "«MongoDB»\nDatabase" as DB

== Api/me/Favorites ==
Client -> Server : POST /api/me/favorites
activate Server
Server -> Router : router.post('/me/favorites', protect, createFavorite)
activate Router
Router -> AuthMW : protect(req, res, next)
activate AuthMW
AuthMW -> DB : verify JWT / load user
activate DB
DB --> AuthMW : user / ok
deactivate DB
AuthMW --> Router : next()
deactivate AuthMW
Router -> Ctrl : createFavorite(req, res)
activate Ctrl
Ctrl -> DB : Company.findById(body.companyId)
activate DB
DB --> Ctrl : company?
deactivate DB
alt company not found
  Ctrl --> Client : 404 Not Found
else company exists
  Ctrl -> DB : Favorite.findOne({ user, company })
  activate DB
  DB --> Ctrl : existed?
  deactivate DB
  alt existed
    Ctrl --> Client : 200 OK { duplicate:true, data: existed }
  else not existed
    Ctrl -> DB : Favorite.create({ user, company })
    activate DB
    DB --> Ctrl : favorite
    deactivate DB
    Ctrl -> DB : Favorite.findById(favorite._id).populate('company')
    activate DB
    DB --> Ctrl : populatedFavorite
    deactivate DB
    Ctrl --> Client : 201 Created { duplicate:false, data: populatedFavorite }
  end
end
deactivate Ctrl
deactivate Router
deactivate Server
== Api/me/Favorites ==
@enduml